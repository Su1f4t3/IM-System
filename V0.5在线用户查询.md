graph TD
    A[客户端连接] --> B(创建User对象)
    B --> C[加入OnlineMap]
    C --> D[广播上线消息]

    subgraph 消息处理
        E[客户端发送消息] --> F(Handler接收消息)
        F --> G["DoMessage(msg)"]
        G --> H{消息类型判断}
        H -->|"who"| I[查询在线用户]
        H -->|普通消息| J[调用BroadCast]
        I --> K[返回用户列表给当前用户]
        J --> L(Message Channel)
    end

    L --> M(ListenMessager)
    M --> N[遍历OnlineMap]
    N --> O(发送到各User Channel)
    O --> P(User.ListenMessage)
    P --> Q[写入网络连接]
    Q --> R[客户端接收]

    style G fill:#ff9,stroke:#333,stroke-width:2px
    style H fill:#9ff,stroke:#333,stroke-width:2px